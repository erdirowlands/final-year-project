<!DOCTYPE html>
<html>
<head>
  <title>Institiution.test.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "test/Institiution.test.js";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>Institiution.test.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> BigNumber = web3.BigNumber;
<span class="hljs-keyword">const</span> Utils = web3.utils;

<span class="hljs-keyword">const</span> truffleAssert = <span class="hljs-built_in">require</span>(<span class="hljs-string">"truffle-assertions"</span>);
<span class="hljs-keyword">const</span> { expectRevert, time, BN } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"openzeppelin-test-helpers"</span>);
<span class="hljs-keyword">const</span> { asciiToHex } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"web3-utils"</span>);

<span class="hljs-keyword">const</span> UniversityVoting = artifacts.require(<span class="hljs-string">"UniversityVoting"</span>);
<span class="hljs-keyword">const</span> Institution = artifacts.require(<span class="hljs-string">"Institution"</span>);
<span class="hljs-keyword">const</span> Election = artifacts.require(<span class="hljs-string">"Election"</span>);
<span class="hljs-keyword">const</span> VotingToken = artifacts.require(<span class="hljs-string">"VotingToken"</span>);

<span class="hljs-built_in">require</span>(<span class="hljs-string">"chai"</span>)
  .use(<span class="hljs-built_in">require</span>(<span class="hljs-string">"chai-bignumber"</span>)(BigNumber))
  .should();

contract(<span class="hljs-string">"Institution"</span>, accounts =&gt; {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>UniversityVoting contract is responsible for deploying Institution, so mimick this flow in tests.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">let</span> universityVoting;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>The deployed child Institution contract address of UnviversityVoting.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">let</span> newInstitutionContractAddress;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>The deployed child Election contract address of Institution</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">let</span> newElectionContractAddress;
  <span class="hljs-keyword">let</span> newElectionContractInstance;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>My account as the owner and deployer of the contract.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> developerAccount = accounts[<span class="hljs-number">0</span>];
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Admin accounts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> prospectiveAdmin1 = accounts[<span class="hljs-number">1</span>];
  <span class="hljs-keyword">const</span> prospectiveAdmin2 = accounts[<span class="hljs-number">2</span>];
  <span class="hljs-keyword">const</span> prospectiveAdmin3 = accounts[<span class="hljs-number">3</span>];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Voter accounts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> prospectiveVoter1 = accounts[<span class="hljs-number">4</span>];
  <span class="hljs-keyword">const</span> prospectiveVoter2 = accounts[<span class="hljs-number">5</span>];
  <span class="hljs-keyword">const</span> prospectiveVoter3 = accounts[<span class="hljs-number">6</span>];
  <span class="hljs-keyword">const</span> fakeVoter = accounts[<span class="hljs-number">7</span>];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Candidate accounts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> prospectiveCandidate1 = accounts[<span class="hljs-number">8</span>];
  <span class="hljs-keyword">const</span> prospectiveCandidate2 = accounts[<span class="hljs-number">9</span>];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Institution data</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> institutionName = <span class="hljs-string">"Ulster University"</span>;
  <span class="hljs-keyword">const</span> adminName = <span class="hljs-string">"John Francis"</span>; <span class="hljs-comment">// An admin must be initialised with an Institution</span>
  <span class="hljs-keyword">const</span> newInstitutionRequestData = [institutionName, adminName];

  newRequestDataAsBytes32 = newInstitutionRequestData.map(
    <span class="hljs-function"><span class="hljs-params">newInstitutionRequestData</span> =&gt;</span> asciiToHex(newInstitutionRequestData)
  );

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Admin data</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> newAdminRequestData = [adminName];

  newAdminRequestDataAsBytes32 = newAdminRequestData.map(<span class="hljs-function"><span class="hljs-params">newAdminRequestData</span> =&gt;</span>
    asciiToHex(newAdminRequestData)
  );

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Candidate data</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">let</span> candidateName = <span class="hljs-string">"Jeff James"</span>;
  <span class="hljs-keyword">const</span> newCandidateRequestData = [candidateName];

  newCandidateRequestDataAsBytes32 = newCandidateRequestData.map(
    <span class="hljs-function"><span class="hljs-params">newCandidateRequestData</span> =&gt;</span> asciiToHex(newCandidateRequestData)
  );

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Token amount for this mock election</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> tokenAmount = Utils.toWei(<span class="hljs-string">"1"</span>, <span class="hljs-string">"ether"</span>);

  context(<span class="hljs-string">"Institution contract deployed"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    before(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      universityVoting = <span class="hljs-keyword">await</span> UniversityVoting.deployed();
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>Submit the approval from 'prospective admin' addresss</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">await</span> universityVoting.submitInstitutionApprovalRequest(
        newRequestDataAsBytes32,
        { <span class="hljs-attr">from</span>: prospectiveAdmin1 }
      );
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Developer Approves the request and UniversityVoting contract the new Institution contract.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> universityVoting.approveInstitutionRequest(
        prospectiveAdmin1,
        { <span class="hljs-attr">from</span>: developerAccount }
      );
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Get emitted event from initialiseInstitutionWithAdmin()</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">const</span> log = <span class="hljs-keyword">await</span> transactionReceipt.logs[<span class="hljs-number">0</span>].args;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>Get newly created contract address from event and use truffle-contract to get an instance.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      newInstitutionContractAddress = <span class="hljs-keyword">await</span> Institution.at(log.institution);
    });
    after(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<pre><code>  await universityVoting.kill();
  await newInstitutionContractAddress.kill();
</code></pre>

        </td>
        <td class="code highlight">
          <pre class="javascript">    });

    describe(<span class="hljs-string">"Administrator actions"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      it(<span class="hljs-string">"submits a new admin aproval request"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> newInstitutionContractAddress.submitAdminApprovalRequest(
          newAdminRequestDataAsBytes32,
          { <span class="hljs-attr">from</span>: prospectiveAdmin2 }
        );
      });
      it(<span class="hljs-string">"reverts on second admin approval request while original pending"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">await</span> expectRevert(
          newInstitutionContractAddress.submitAdminApprovalRequest(
            newAdminRequestDataAsBytes32,
            { <span class="hljs-attr">from</span>: prospectiveAdmin2 }
          ),
          <span class="hljs-string">"You have an outstanding request, please wait for that to be processed"</span>
        );
      });
      it(<span class="hljs-string">"approves the new admin request."</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> newInstitutionContractAddress.approveAdminRequest(
          prospectiveAdmin2,
          { <span class="hljs-attr">from</span>: prospectiveAdmin1 }
        );
        truffleAssert.eventEmitted(transactionReceipt, <span class="hljs-string">"LogNewAdmin"</span>, event =&gt; {
          <span class="hljs-keyword">return</span> prospectiveAdmin2.should.equal(event.newAdmin);
        });
      });

      it(<span class="hljs-string">"stores the new admin address in array"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>Check if initialiseInstitutionWithAdmin() called from the beforeEach hook
stores the address in the array.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> adminThatShouldBeStored = <span class="hljs-keyword">await</span> newInstitutionContractAddress._adminAddresses(
          <span class="hljs-number">1</span>
        );
        adminThatShouldBeStored.should.equal(prospectiveAdmin2);
      });
      it(<span class="hljs-string">"ensures admin has been initialised with the correct values"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> resultName = <span class="hljs-keyword">await</span> newInstitutionContractAddress.getInstitutionName();
        resultName.should.equal(<span class="hljs-string">"Ulster University"</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>Get the admin's firstname, surname, address, and if they are authorised</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> admin = <span class="hljs-keyword">await</span> newInstitutionContractAddress.getAdmin(
          prospectiveAdmin2
        );
        admin[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"John Francis"</span>);
        admin[<span class="hljs-number">1</span>].should.equal(<span class="hljs-literal">true</span>);
      });
      it(<span class="hljs-string">"reverts when a currently unauthorised admin tries to add another admin"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> newAdminName = <span class="hljs-string">"JimHolden "</span>;
        <span class="hljs-keyword">await</span> newInstitutionContractAddress.unauthoriseAdmin(prospectiveAdmin2);
        <span class="hljs-keyword">await</span> expectRevert(
          newInstitutionContractAddress.addNewAdmin(
            newAdminName,
            prospectiveAdmin3,
            { <span class="hljs-attr">from</span>: prospectiveAdmin2 }
          ),
          <span class="hljs-string">"Caller is an admin, but not currently authorised!"</span>
        );
      });
    });
    describe(<span class="hljs-string">"Election creation"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      it(<span class="hljs-string">"creates a new election."</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>let date = (new Date()).getTime();</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> description = <span class="hljs-string">"Start of term election"</span>;
        <span class="hljs-keyword">await</span> time.advanceBlock();
        <span class="hljs-keyword">const</span> electionStartTime = <span class="hljs-keyword">await</span> time.latest();
        <span class="hljs-keyword">const</span> electionEndTime =
          (<span class="hljs-keyword">await</span> electionStartTime) + time.duration.weeks(<span class="hljs-number">1</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>let dateInUnixTimestamp = date / 1000;</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> newInstitutionContractAddress.createElection(
          electionStartTime,
          electionEndTime,
          description,
          { <span class="hljs-attr">from</span>: prospectiveAdmin1 }
        );
        <span class="hljs-keyword">const</span> log = <span class="hljs-keyword">await</span> transactionReceipt.logs[<span class="hljs-number">0</span>].args;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>Get newly created contract address from event and use truffle-contract to get an instance.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        newElectionContractAddress = <span class="hljs-keyword">await</span> log.election;
        truffleAssert.eventEmitted(
          transactionReceipt,
          <span class="hljs-string">"NewElectionCreated"</span>,
          event =&gt; {
            <span class="hljs-keyword">return</span> newElectionContractAddress.should.equal(event.election);
          }
        );
        newElectionContractInstance = <span class="hljs-keyword">await</span> Election.at(
          newElectionContractAddress
        );
      });
      it(<span class="hljs-string">"stores the new election address in array"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>Check if initialiseInstitutionWithAdmin() called from the beforeEach hook
stores the address in the array.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> electionAddressThatShouldBeStored = <span class="hljs-keyword">await</span> newInstitutionContractAddress._electionAddresses(
          <span class="hljs-number">0</span>
        );
        electionAddressThatShouldBeStored.should.equal(
          newElectionContractAddress
        );
      });
    });
    describe(<span class="hljs-string">"Candidate approval requests"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      it(<span class="hljs-string">"lets a candidate submit a request"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> newInstitutionContractAddress.submitCandidateApprovalRequest(
          newCandidateRequestDataAsBytes32,
          newElectionContractAddress,
          { <span class="hljs-attr">from</span>: prospectiveCandidate1 }
        );
      });
      it(<span class="hljs-string">"reverts on second candidate approval request while original pending"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">await</span> expectRevert(
          newInstitutionContractAddress.submitCandidateApprovalRequest(
            newCandidateRequestDataAsBytes32,
            newElectionContractAddress,
            { <span class="hljs-attr">from</span>: prospectiveCandidate1 }
          ),
          <span class="hljs-string">"You have an outstanding request, please wait for that to be processed"</span>
        );
      });
      it(<span class="hljs-string">"lets admin approve the new candidate request"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> newInstitutionContractAddress.approveCandidateRequest(
          prospectiveCandidate1,
          { <span class="hljs-attr">from</span>: prospectiveAdmin1 }
        );
        truffleAssert.eventEmitted(
          transactionReceipt,
          <span class="hljs-string">"NewCandidateApproved"</span>,
          event =&gt; {
            <span class="hljs-keyword">return</span> prospectiveCandidate1.should.equal(event.candidate);
          }
        );
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>Check if candidate has been added to the Election created earlier.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> isCandidateStored = <span class="hljs-keyword">await</span> newElectionContractInstance.isCandidateAddressStored(
          prospectiveCandidate1
        );
        isCandidateStored.should.equal(<span class="hljs-literal">true</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>const candidateArray = newElectionContractInstance._candidateArray(0);
candidateArray.should.equal(prospectiveCandidate1);</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
      });
      it(<span class="hljs-string">"lets a second candidate submit a request and get approved"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> transactionSubmissionReceipt = <span class="hljs-keyword">await</span> newInstitutionContractAddress.submitCandidateApprovalRequest(
          newCandidateRequestDataAsBytes32,
          newElectionContractAddress,
          { <span class="hljs-attr">from</span>: prospectiveCandidate2 }
        );
        <span class="hljs-keyword">const</span> transactionApprovalReceipt = <span class="hljs-keyword">await</span> newInstitutionContractAddress.approveCandidateRequest(
          prospectiveCandidate2,
          { <span class="hljs-attr">from</span>: prospectiveAdmin1 }
        );
        truffleAssert.eventEmitted(
          transactionApprovalReceipt,
          <span class="hljs-string">"NewCandidateApproved"</span>,
          event =&gt; {
            <span class="hljs-keyword">return</span> prospectiveCandidate2.should.equal(event.candidate);
          }
        );
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>Check if candidate has been added to the Election created earlier.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> isCandidateStored = <span class="hljs-keyword">await</span> newElectionContractInstance.isCandidateAddressStored(
          prospectiveCandidate2
        );
        isCandidateStored.should.equal(<span class="hljs-literal">true</span>);
      });
    });
    describe(<span class="hljs-string">"Voter approval requests"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      it(<span class="hljs-string">"lets a voter submit a request"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> newInstitutionContractAddress.submitVoterApprovalRequest(
          newElectionContractAddress,
          { <span class="hljs-attr">from</span>: prospectiveVoter1 }
        );
      });
      it(<span class="hljs-string">"reverts on second voter approval request while original pending"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">await</span> expectRevert(
          newInstitutionContractAddress.submitVoterApprovalRequest(
            newElectionContractAddress,
            { <span class="hljs-attr">from</span>: prospectiveVoter1 }
          ),
          <span class="hljs-string">"You have an outstanding request, please wait for that to be processed"</span>
        );
      });
      it(<span class="hljs-string">"lets admin approve the new voter request and issue 1 VotingToken"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>let decimals = Utils.toBN(18);
let amount = Utils.toBN(10);
let value = amount.mul(Utils.toBN(1).pow(decimals));</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> newInstitutionContractAddress.approveVoterRequest(
          prospectiveVoter1,
          tokenAmount,
          { <span class="hljs-attr">from</span>: prospectiveAdmin1 }
        );
        truffleAssert.eventEmitted(
          transactionReceipt,
          <span class="hljs-string">"NewVoterApproved"</span>,
          event =&gt; {
            <span class="hljs-keyword">return</span> prospectiveVoter1.should.equal(event.voter);
          }
        );
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>Check if the voter's token balance matches what was sent to them.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> voterTokenBalance = <span class="hljs-keyword">await</span> newElectionContractInstance.getTokenBalance(
          { <span class="hljs-attr">from</span>: prospectiveVoter1 }
        );
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>const usefulBalance = Utils.toWei(voterTokenBalance, 'ether');</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> actual = web3.utils.toBN(voterTokenBalance).toString();
        <span class="hljs-keyword">const</span> before = web3.utils.toBN(tokenAmount).toString();
        actual.should.equal(before);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>usefulBalance.should.be.bignumber.equal(voterTokenBalance);</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      });
      it(<span class="hljs-string">"lets a second voter submit a request and get approved with 1 token"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> transactionSubmissionReceipt = <span class="hljs-keyword">await</span> newInstitutionContractAddress.submitVoterApprovalRequest(
          newElectionContractAddress,
          { <span class="hljs-attr">from</span>: prospectiveVoter2 }
        );
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>let decimals = Utils.toBN(18);
let amount = Utils.toBN(10);
let value = amount.mul(Utils.toBN(1).pow(decimals));</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> newInstitutionContractAddress.approveVoterRequest(
          prospectiveVoter2,
          tokenAmount,
          { <span class="hljs-attr">from</span>: prospectiveAdmin1 }
        );
        truffleAssert.eventEmitted(
          transactionReceipt,
          <span class="hljs-string">"NewVoterApproved"</span>,
          event =&gt; {
            <span class="hljs-keyword">return</span> prospectiveVoter2.should.equal(event.voter);
          }
        );
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>Get the voter's approved token balance.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> voterTokenBalance = <span class="hljs-keyword">await</span> newElectionContractInstance.getTokenBalance(
          { <span class="hljs-attr">from</span>: prospectiveVoter2 }
        );
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>Make sure the voter's new balance equals what was issued to them upon approval.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> voterTokenBalanceBigNumber = web3.utils.toBN(voterTokenBalance).toString();
        <span class="hljs-keyword">const</span> approvedTokenAmountBigNumber = web3.utils.toBN(tokenAmount).toString();
        voterTokenBalanceBigNumber.should.equal(approvedTokenAmountBigNumber);
      });
    });
    describe(<span class="hljs-string">"Election voting"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      it(<span class="hljs-string">"lets a voter vote for a candidate by sending one voting token"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<div class="dox">
<div class="summary">
<p>//  const tokenAmount = Utils.toWei('1', 'ether');
let tokenAmountBefore = 1000000000000000000;
let tokenAmountAfter = web3.utils.toBN(tokenAmountBefore).toString();
const transactionReceipt = await newElectionContractInstance.vote(
prospectiveCandidate1,
//new BigNumber(Utils.toWei(1, 'ether')),
tokenAmountAfter,
{ from: prospectiveVoter1 }
);</p>
</div>
<div class="body">
</div>
</div>
 const voterTokenBalance = await newElectionContractInstance.getVoterTokenbalance(prospectiveVoter1);
  const actual  = web3.utils.toBN(voterTokenBalance).toString();
  actual.should.equal('1000000000000000000');

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> newElectionContractInstance.vote(
          prospectiveCandidate1,
          tokenAmount,
          { <span class="hljs-attr">from</span>: prospectiveVoter1 }
        );
        <span class="hljs-keyword">const</span> candidateTokenBalance = <span class="hljs-keyword">await</span> newElectionContractInstance.getTokenBalance(
          { <span class="hljs-attr">from</span>: prospectiveCandidate1 }
        );
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>Get the voter's new token balance after the vote.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> voterNewTokenBalance = <span class="hljs-keyword">await</span> newElectionContractInstance.getTokenBalance(
          { <span class="hljs-attr">from</span>: prospectiveVoter1 }
        ); 
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>Make sure the balance is now zero.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> voterBalanceBigNumber = web3.utils.toBN(voterNewTokenBalance).toString();
        voterBalanceBigNumber.should.equal(<span class="hljs-string">'0'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>Then make sure the candidate now has the token.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> candidateBalanceBigNumber = web3.utils.toBN(candidateTokenBalance).toString();
        <span class="hljs-keyword">const</span> votingAmountBigNumber = web3.utils.toBN(tokenAmount).toString();
        candidateBalanceBigNumber.should.equal(votingAmountBigNumber);
      });
      it(<span class="hljs-string">"reverts if an approved voter tries to vote with no available tokens"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">await</span> expectRevert(
          newElectionContractInstance.vote(
          prospectiveCandidate1,
          tokenAmount,
          { <span class="hljs-attr">from</span>: prospectiveVoter1 }
        ),
          <span class="hljs-string">"Voter doesn't have any Voting Tokens!"</span>
        );
      });
      it(<span class="hljs-string">"reverts if an unapproved address tries to vote "</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">await</span> expectRevert(
          newElectionContractInstance.vote(
          prospectiveCandidate1,
          tokenAmount,
          { <span class="hljs-attr">from</span>: fakeVoter }
        ),
          <span class="hljs-string">"Voter address isn't stored"</span>
        );
      });
    });
    describe(<span class="hljs-string">"Election Conclusion"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      it(<span class="hljs-string">"tallys the election and returns the correct winner"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> transactionSubmissionReceipt = <span class="hljs-keyword">await</span> newInstitutionContractAddress.submitVoterApprovalRequest(
          newElectionContractAddress,
          { <span class="hljs-attr">from</span>: prospectiveVoter3 }
        );
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>let decimals = Utils.toBN(18);
let amount = Utils.toBN(10);
let value = amount.mul(Utils.toBN(1).pow(decimals));</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> newInstitutionContractAddress.approveVoterRequest(
          prospectiveVoter3,
          tokenAmount,
          { <span class="hljs-attr">from</span>: prospectiveAdmin1 }
        );
        <span class="hljs-keyword">const</span> transactionVoteReceipt = <span class="hljs-keyword">await</span> newElectionContractInstance.vote(
          prospectiveCandidate2,
          tokenAmount,
          { <span class="hljs-attr">from</span>: prospectiveVoter2 }
        );
        <span class="hljs-keyword">const</span> transactionVoteReceipt2 = <span class="hljs-keyword">await</span> newElectionContractInstance.vote(
          prospectiveCandidate1,
          tokenAmount,
          { <span class="hljs-attr">from</span>: prospectiveVoter3}
        );
      <span class="hljs-keyword">const</span> concludeElection = <span class="hljs-keyword">await</span> newElectionContractInstance.concludeElection({<span class="hljs-attr">from</span>: prospectiveAdmin1});
      <span class="hljs-keyword">const</span> winner = <span class="hljs-keyword">await</span>  newElectionContractInstance.getVictor();
      winner.should.equal(prospectiveCandidate1);
      });
    }); 
  });
});

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>

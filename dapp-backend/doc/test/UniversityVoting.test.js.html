<!DOCTYPE html>
<html>
<head>
  <title>UniversityVoting.test.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "test/UniversityVoting.test.js";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>UniversityVoting.test.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">const</span> { expectRevert } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"openzeppelin-test-helpers"</span>);
<span class="hljs-keyword">const</span> { asciiToHex } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"web3-utils"</span>);
<span class="hljs-keyword">const</span> BigNumber = web3.BigNumber;
<span class="hljs-keyword">const</span> UniversityVoting = artifacts.require(<span class="hljs-string">"UniversityVoting"</span>);
<span class="hljs-keyword">const</span> Institution = artifacts.require(<span class="hljs-string">"Institution"</span>);
<span class="hljs-keyword">const</span> VotingToken = artifacts.require(<span class="hljs-string">"VotingToken"</span>);

<span class="hljs-built_in">require</span>(<span class="hljs-string">"chai"</span>)
  .use(<span class="hljs-built_in">require</span>(<span class="hljs-string">"chai-bignumber"</span>)(BigNumber))
  .should();

contract(<span class="hljs-string">"UniversityVoting"</span>, accounts =&gt; {
  <span class="hljs-keyword">let</span> universityVoting;
  <span class="hljs-keyword">let</span> deployedVotingToken;
  <span class="hljs-keyword">let</span> newInstitutionContractAddress;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Me, as the owner and deployer of the contract.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> developerAccount = accounts[<span class="hljs-number">0</span>];
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Account for admin who makes a request for a new Institution</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">const</span> prospectiveAdminAccount = accounts[<span class="hljs-number">1</span>];

  <span class="hljs-keyword">const</span> newInstitutionRequestData = [<span class="hljs-string">"Ulster University"</span>, <span class="hljs-string">"John Francis"</span>];
  (newRequestDataAsBytes32 = newInstitutionRequestData.map(
    <span class="hljs-function"><span class="hljs-params">newInstitutionRequestData</span> =&gt;</span> asciiToHex(newInstitutionRequestData)
  )),
    describe(<span class="hljs-string">"Approving and creating a new Institution contract and operations on the newly created contract"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
      before(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Deploy Voting Token and University Voting contracts</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        universityVoting = <span class="hljs-keyword">await</span> UniversityVoting.deployed();
          <span class="hljs-keyword">from</span>: developerAccount
      });
      after(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">await</span> universityVoting.kill();
      });

      it(<span class="hljs-string">"submits a new institution aproval request"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> universityVoting.submitInstitutionApprovalRequest(
          newRequestDataAsBytes32,
          { <span class="hljs-attr">from</span>: prospectiveAdminAccount }
        );
      });
      it(<span class="hljs-string">"reverts on second approval request while original pending"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">await</span> expectRevert(
          universityVoting.submitInstitutionApprovalRequest(
            newRequestDataAsBytes32,
            { <span class="hljs-attr">from</span>: prospectiveAdminAccount }
          ),
          <span class="hljs-string">"You have an outstanding request, please wait for that to be processed"</span>
        );
      });

      it(<span class="hljs-string">"approves and creates a new Institution contract."</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> universityVoting.approveInstitutionRequest(
          prospectiveAdminAccount,
          { <span class="hljs-attr">from</span>: developerAccount }
        );
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Get emitted event from initialiseInstitutionWithAdmin()</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> log = <span class="hljs-keyword">await</span> transactionReceipt.logs[<span class="hljs-number">0</span>].args;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Get newly created contract address from event</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        newInstitutionContractAddress = <span class="hljs-keyword">await</span> log.institution;
      });
      it(<span class="hljs-string">"reverts on a non-developer/'owner trying attempting to authorise an approval"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Create a new approval request.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> transactionReceipt = <span class="hljs-keyword">await</span> universityVoting.submitInstitutionApprovalRequest(
          newRequestDataAsBytes32,
          { <span class="hljs-attr">from</span>: accounts[<span class="hljs-number">5</span>] } <span class="hljs-comment">// This account is not the developer/owner, so it should be rejected.</span>
        );
        <span class="hljs-keyword">await</span> expectRevert(
          universityVoting.approveInstitutionRequest(accounts[<span class="hljs-number">5</span>], {
            <span class="hljs-attr">from</span>: prospectiveAdminAccount
          }),
          <span class="hljs-string">"Ownable: caller is not the owner."</span>
        );
      });
      it(<span class="hljs-string">"stores institution contract address in addresses array"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Check if initialiseInstitutionWithAdmin() called from the beforeEach hook
stores the address in the array.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> addressThatShouldBeStored = <span class="hljs-keyword">await</span> universityVoting._addressArray(
          <span class="hljs-number">0</span>
        );
        addressThatShouldBeStored.should.equal(newInstitutionContractAddress);
      });
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>approveRequst relies on some relativley contrived bytes32 manipulation, because
strings still really aren't a primitive type in solidity :(
so ensure that manipulation has been done correctly.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      it(<span class="hljs-string">"ensures institution has been initialised with the correct values"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        deployedInstitutionContract = <span class="hljs-keyword">await</span> Institution.at(
          newInstitutionContractAddress
        );
        <span class="hljs-keyword">const</span> resultName = <span class="hljs-keyword">await</span> deployedInstitutionContract.getInstitutionName();
        resultName.should.equal(<span class="hljs-string">"Ulster University"</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Get the admin's firstname, surname, address, and if they are authorised</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">const</span> admin = <span class="hljs-keyword">await</span> deployedInstitutionContract.getAdmin(
          prospectiveAdminAccount
        );
        admin[<span class="hljs-number">0</span>].should.equal(<span class="hljs-string">"John Francis"</span>);
        admin[<span class="hljs-number">1</span>].should.equal(<span class="hljs-literal">true</span>);
      });
      it(<span class="hljs-string">"reverts on attempting to approve a non-existent approval"</span>, <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">await</span> expectRevert(
          universityVoting.approveInstitutionRequest(developerAccount, {
            <span class="hljs-attr">from</span>: developerAccount
          }),
          <span class="hljs-string">"Approval not found"</span>
        );
      });
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<div class="dox">
<div class="summary">
<p>it(&quot;stores contract address in addresses mapping&quot;, async function() {
// Check if initialiseInstitutionWithAdmin() called from the beforeEach hook
// stores the address in the array.
const isAddressStored = await universityVoting.isInstitutionAddressStored(
newInstitutionContractAddress
);
isAddressStored.should.equal(true);
});
it(&quot;gets the number of stored instituion addresses&quot;, async function() {
const totalAddresses = (await universityVoting.getInstitutionsTotal()).toNumber();
totalAddresses.should.equal(1);
});
it(&quot;reverts when attempting to store a duplicate contract address in address mapping&quot;, async function() {
await expectRevert(
universityVoting.addInstitutionAddresstoMapping(
newInstitutionContractAddress
),
&quot;This institution has already been added&quot;
);
});</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">    });

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<div class="dox">
<div class="summary">
<p>// TODO MOVE TO INSTITUTION TEST!!!
describe(&quot;institution owners&quot;, function() {
it(&quot;add a new institution owner&quot;, async function() {
await this.universityVoting.addInstitutionOwners(accounts[1]);
const newInstitutionOwner = await this.universityVoting._institutionAdmins(accounts[1]);
newInstitutionOwner.should.equal(true);
});</p>
</div>
<div class="body">
<p>it(&quot;get an institution owner&quot;, async function() {
const institutionOwner = await this.universityVoting.getInstitutionOwner(accounts[0]);
institutionOwner.should.equal(true);
});
});</p>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">});

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
